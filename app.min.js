document.onkeydown = function(e) {
    if (e.key === 'Escape') {
        change_active(['cities', 'overlay', 'cities-container']);
        return false;
    }
};



let select_city = document.querySelector('.select-city');
select_city.addEventListener('click', function() {
    show_citylist();
    return false;
});
let directory_link = document.querySelector('.menu-list__link_place_directory');

directory_link.addEventListener('click', function() {
    change_active(['submenu-list']);
    return false;
});


let logo_menu = document.querySelector('.header__logo');
let info_close = document.querySelector('.header-info_action_close');

logo_menu.addEventListener('click', function() {
    change_active(['header-info']);
    return false;
});

info_close.addEventListener('click', function() {
    change_active(['header-info']);
    return false;
});

let icon = document.querySelector('.search-form__icon');
icon.addEventListener('click', function() {
    change_active([
        'search-form',
        'search-form__icon',
        'search-form__label',
        'search-form__input',
        'search-form__button',
    ]);
});
function build_citylist(data, container) {
    container.innerHTML = '';
    data.forEach(function (item, i) {
        let li = document.createElement('li');
        li.setAttribute('data-id', item.id);
        li.innerHTML = item.name;
        container.appendChild(li);
    });
}
function change_active(selectors=[]) {
    for (i=0; i < selectors.length; i++) {
        let selector = selectors[i];
        let container = document.querySelector('.' + selector);
        if(container.classList.contains(selector + '_active')) {
            container.classList.remove(selector + '_active');
        } else {
            container.classList.add(selector + '_active');
        }
    }



}
function get_json(url, data) {
    return fetch(url, {
        credentials: 'same-origin',  // параметр определяющий передвать ли разные сессионные данные вместе с запросом
        method: 'POST',              // метод POST
        body: JSON.stringify(data),  // типа запрашиаемого документа
        headers: new Headers({
            'Content-Type': 'application/json'
        }),
    })
        .then(response => response.json()) // возвращаем промис
}
function show_citylist() {
    change_active(['cities', 'overlay', 'cities-container']);

    let container = document.querySelector('.cities-container');

    container.innerHTML = '' +
        '<input type="text" class="cities-container__search">' +
        '<ul class="cities-container__content"></ul>' +
        '<button class="cities-container__close">Закрыть</button>';

    let cities_ul = document.querySelector('.cities-container__content');
    cities_ul.innerHTML = '<li class="cities-container__loader">Загрузка городов...</li>';


    get_json('/cities.js', {user: 'Krunal'})
        .then(data => build_citylist(data, cities_ul))      // обрабатываем результат вызова response.json()
        .catch(error => console.error(error))

    let container__search  = document.querySelector('.cities-container__search');
    container__search.addEventListener('keyup', function() {
        let query = container__search.value;
        if(query.length >= 3) {
            get_json('/cities.js', {query: query})
                .then(data => build_citylist(data, cities_ul))      // обрабатываем результат вызова response.json()
                .catch(error => console.error(error));
        }

    });


    let cities_close = document.querySelector('.cities-container__close');
    cities_close.addEventListener('click', function() {
        change_active(['cities', 'overlay', 'cities-container']);
        return false;
    });
}